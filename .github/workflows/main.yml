name: Deploy YMU_App to Raspberry Pi

on:
  push:
    branches:
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: ğŸš€ Kodu Checkout Et
      uses: actions/checkout@v4

    - name: ğŸ›  .NET Build (Runner Ã¼zerinde Ã¶n derleme)
      run: |
        dotnet restore YMU_App.csproj # .csproj dosyanÄ±zÄ±n adÄ±nÄ± kontrol edin
        dotnet build YMU_App.csproj --configuration Release # .csproj dosyanÄ±zÄ±n adÄ±nÄ± kontrol edin

    - name: Install Tailscale (Opsiyonel)
      if: ${{ secrets.TAILSCALE_AUTHKEY != '' }}
      run: |
        curl -fsSL https://tailscale.com/install.sh | sh
        sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTHKEY }} --hostname github-runner-${{ github.run_id }}

    - name: ğŸ”‘ SSH Key Kurulumu ve Sunucuya BaÄŸlantÄ± HazÄ±rlÄ±ÄŸÄ±
      run: |
        echo "Creating .ssh directory"
        mkdir -p $HOME/.ssh
        echo "Setting permissions for .ssh"
        chmod 700 $HOME/.ssh
        echo "Adding private key"
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > $HOME/.ssh/id_ed25519 # KullandÄ±ÄŸÄ±nÄ±z anahtar tipine gÃ¶re (Ã¶rn: id_rsa) deÄŸiÅŸtirebilirsiniz
        chmod 600 $HOME/.ssh/id_ed25519
        echo "Running ssh-keyscan"
        ssh-keyscan -p ${{ secrets.SSH_PORT || '22' }} ${{ secrets.SSH_HOST }} >> $HOME/.ssh/known_hosts || true
        echo "Listing .ssh directory"
        ls -la $HOME/.ssh

    - name: ğŸ’‚ğŸ» Mevcut Konteyneri Durdur ve Sil
      run: |
        ssh -i $HOME/.ssh/id_ed25519 \
            -oKexAlgorithms=+diffie-hellman-group14-sha1 -oCiphers=aes128-ctr \
            -o StrictHostKeyChecking=no \
            -p ${{ secrets.SSH_PORT || '22' }} \
            ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
          docker stop ymuapp || true   # Konteyner adÄ±nÄ±zÄ± buraya yazÄ±n
          docker rm ymuapp || true     # Konteyner adÄ±nÄ±zÄ± buraya yazÄ±n
        EOF

    - name: ğŸ“‚ Sunucuya Proje DosyalarÄ±nÄ± Kopyala
      run: |
        scp -i $HOME/.ssh/id_ed25519 \
            -oKexAlgorithms=+diffie-hellman-group14-sha1 -oCiphers=aes128-ctr \
            -o StrictHostKeyChecking=no \
            -P ${{ secrets.SSH_PORT || '22' }} \
            -r ./ \
            ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:/home/${{ secrets.SSH_USER }}/ymuapp # Hedef klasÃ¶r adÄ±nÄ± buraya yazÄ±n

    - name: ğŸ”„ Sunucuda Docker Image OluÅŸtur
      run: |
        ssh -i $HOME/.ssh/id_ed25519 \
            -oKexAlgorithms=+diffie-hellman-group14-sha1 -oCiphers=aes128-ctr \
            -o StrictHostKeyChecking=no \
            -p ${{ secrets.SSH_PORT || '22' }} \
            ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
          cd /home/${{ secrets.SSH_USER }}/ymuapp
          docker build -t ymuapp:latest .
        EOF

    - name: ğŸš€ Sunucuda Docker Konteynerini Ã‡alÄ±ÅŸtÄ±r
      run: |
        ssh -i $HOME/.ssh/id_ed25519 \
            -oKexAlgorithms=+diffie-hellman-group14-sha1 -oCiphers=aes128-ctr \
            -o StrictHostKeyChecking=no \
            -p ${{ secrets.SSH_PORT || '22' }} \
            ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
          # Raspberry Pi'nin 1001 portunu konteynerin 8080 portuna yÃ¶nlendiriyoruz.
          # Dockerfile'Ä±nÄ±zdaki uygulamanÄ±z konteyner iÃ§inde 8080 portunu dinliyor olmalÄ±.
          docker run -d -p 1001:8080 --restart always --name ymuapp ymuapp:latest
        EOF
